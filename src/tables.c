/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
  -12,  12, -26,  21,  19,  75,  -1, -38,
   -6, -35,  11,  -8,  40,  57,  20, -24,
  -19,   4, -12,  -3,  -7,  -6,  -5, -29,
  -26, -40, -11, -14, -10, -17, -34, -43,
  -32, -27, -38, -28, -24, -30, -14, -38,
  -35, -18, -29, -29, -23,  -7,   2, -31,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -160, -85, -88, -43,  -2,-112, -75,-112,
  -46, -35, 109,  21,  50,  75,  35, -17,
   -7,  81,  46,  55,  95, 123,  90,  48,
   40,  55,  43,  69,  58,  67,  49,  41,
   45,  49,  56,  55,  71,  65,  58,  53,
   25,  22,  29,  39,  50,  53,  55,  31,
   18,   2,  21,  25,  40,  35,  38,  34,
  -50,  39, -10,  19,  48,  16,  29,  37
  }, {
    2,  -5,-110,-101, -72, -88,   4,  17,
  -16,  24, -11, -42,  19,  56,  27, -49,
    9,  35,  66,  36,  54,  58,  37,  34,
    7,  50,  26,  57,  41,  45,  43,  11,
   28,  23,  32,  44,  61,  38,  34,  46,
   17,  36,  27,  28,  34,  49,  40,  30,
   25,  37,  33,  12,  19,  35,  56,  29,
    7,  31,  24,  14,  25,  11,  -3,  15
  }, {
   -6,  19, -34,  27,  34, -24, -14, -26,
   -7,   9,  20,  30,  38,  26, -15,   0,
  -18,   4,  12,   5,  -1,   4,  48, -28,
  -28,  -1,   8,  22,  15,  34, -19, -22,
  -34, -17,  -3,   1,  13,  -1,  16, -29,
  -31,  -7,  -7,  -6,  -3,   6, -10, -31,
  -22, -10, -14,  -3,   9,   4,  -2, -57,
   -4,   0,   7,  16,  14,   8, -28,  -5
  }, {
   -7, -11,  34,  21,  65,  52,  38,  54,
  -35, -66,  -9, -22, -59,  -3, -14,   6,
    1,   1,  21, -13,  12,  22,  29,  36,
  -34,  -1, -22, -23,  -2,  10,   9,   5,
   15, -18,   8,  -6,  16,  16,  14,   5,
   -2,  21,   0,  15,  12,  11,  28,   7,
   -2,  16,  32,  13,  24,  34,  14,  31,
   17,   9,  17,  32,  13,   5,  11, -14
  }, {
  -36,  48,  62, -19, -95, -49,  53,  61,
   27,  75,  40,  38,  24,  25, -22, -27,
  -26,  56, 143,  24,  63, 123,  73, -44,
  -55,  49,  59, -24,  19,  29,  32,-113,
  -75,  24,  12,  -9, -16,  11,   3,-100,
  -55,   8, -13,  -6, -36, -15,   3, -47,
   -5,  11,  -5, -43, -29,   0,  12,  15,
  -19,  20,   4, -53,   8, -33,  23,   9
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    8,  20,  23,  23,  39,  16,  42,  39,
    6,   7,   4,   2,   1,   1,  14,  14,
    0,  -9, -11, -15, -13, -11,  -3,  -3,
   -7,  -9, -16, -19, -16, -16, -13, -14,
  -14, -13, -15, -13, -12, -12, -17, -19,
  -11, -12,  -7, -11,  -6,  -6, -10, -19,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -50, -40, -10, -30, -17, -36, -56, -81,
  -30, -12, -26,  -1, -14, -24, -22, -49,
  -32, -16,   5,   5,  -3,  -6, -18, -40,
  -15,  -1,  15,  15,  13,   8,  -6, -15,
   -8,  -7,  11,  16,  12,  12,   4,  -8,
  -18,  -5,   2,  10,   7,  -1, -16,  -7,
  -26, -19, -11,  -1,   0, -12, -16, -30,
  -18, -24, -18,  -2, -15, -13, -22, -36
  }, {
  -15, -20, -24, -20, -15, -15, -15, -21,
   -9,  -7,  -7, -15,  -8, -10,  -8, -20,
   -6,  -9,  -5,  -7,  -5,   2,  -4,  -7,
   -7,  -4,   3,   7,   8,   3,  -7,  -4,
   -8,  -2,   4,   9,   1,   4,  -5,  -9,
  -10,  -5,   3,   2,   4,  -1,  -3,  -8,
  -11, -14, -11,  -4,  -1,  -8, -12, -22,
  -23,  -7,  -8,  -8,  -9,  -8,  -6,  -9
  }, {
   33,  31,  39,  36,  36,  35,  33,  30,
   26,  26,  27,  25,  18,  27,  33,  25,
   21,  24,  19,  23,  18,  17,  20,  13,
   21,  18,  27,  17,  19,  20,  15,  20,
   25,  26,  29,  23,  19,  18,  16,  17,
   22,  22,  19,  21,  18,  15,  20,  12,
   21,  19,  24,  24,  19,  16,  14,  20,
   20,  22,  21,  17,  16,  16,  21,   9
  }, {
    6,  40,  24,  34,  31,  20,  20,  45,
    9,  15,  15,  41,  49,  37,  36,  20,
    4,   2, -12,  36,  41,  23,  13,  18,
   42,  21,  28,  28,  32,  24,  45,  37,
   11,  44,  30,  39,  21,  21,  45,  46,
   22,   8,  31,  23,  25,  28,  28,  51,
   15,   2,   2,  19,  17,   1,  -3,  14,
    2,   0,  -1, -17,  15,  -2,  13,  -8
  }, {
  -88, -39,  -4, -22,  -5,   7, -14, -20,
  -25,   2,  10,  11,   7,  20,   2,   1,
   -2,   5,   7,   4,   5,  29,  28,   0,
   -5,  10,  13,   9,   5,  13,  11,  -2,
   -4,  -1,  14,   9,   9,  12,   3,  -5,
   -1,   6,  13,   8,   9,  12,   9,  -3,
  -18,  -1,  10,   5,   6,   8,   2, -11,
  -42, -18,  -5,  -4, -14,   2, -12, -34
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    4,  16,  16,   4,  11,  15,  11,   1,
    5,  19,   1,   1,   5,   7,   8,   8,
    5, -12,  -1,   7,  -1,  -2,  -5,   7,
   30,  -5,   9,  -2,  -3,  -3,  -8,   3,
   40, 103,  25, -20, -26,  -6,  -1,   0,
  -19, -25,  23,  54,  32,  -2, -61, -12,
  -19, -24, -12,  -8,  -6, -10, -13, -13
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
   -3, -92, -26, -59, -21, -21, -35, -31,
   11,   8,  -2, -10,  -8,  -6,   7,  12,
    9,   0,  -2,   5,   2,  -6,  -1,   2,
    0,  29,   0,   7,   9,  -6,   6,   6,
    2,  14,   5,   3,  -2,   3,  -2,   2,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
   -5,  20,  39, -39, -84, -81,   4,   5,
  -21,-138,  -4, -13, -25, -43, -18,  17,
  -12,  58, -27, -15, -22, -12,  -3,  21,
  -20,  12, -10, -13, -21,  -8, -14,  -5,
   25,  24,   5,   4,   5,  -5,  18,  -1,
   -8,  -4,  -1,  -2, -13,   9,   2,  -5,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     23,  44,  12, -16,  78,  16,  48,   1,
     -7,  -8,  -2,  19,  22,  22,   8,  25,
     -3,  13,   6,   8,  15,  17,  21,  12,
      1,   9,  13,  11,  14,  13,  19,  14,
      8,  -2,   6,  -2,   4,   3,   9,   6,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     26,  25,  44,  -5,  61,  38,  14,  37,
      7,   9,   3,   1,  11,  11,   2,   2,
      1,   2,   5,   6,   3,   6,   0,   0,
     -2,   1,   4,   4,   7,   2,   2,  -3,
     -2,   4,  -4,   5,   5,  -5,  -2, -16,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    130,  61, 101,  98, 160, 109,  37,  44,
     13,  17,  48,  14,  68,  34,  54,  43,
     43,  21,  36,  27,  44,  53,  53,  60,
     28,  41,  17,  23,  27,  15,  28,  33,
      8,  28,  18,  26,  27,  19,  35,  15,
     21,  15,  15,  16,  13,   3,  17,  -1,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     32,  42,  67,  36, 130, 109,  29,  50,
     47,  59,  34,  50,  54,  67,  54,  44,
     29,  22,  25,  25,  26,  20,  24,  24,
     13,   9,   7,  18,  12,  10,  13,  12,
     -1,   3,  10,  13,   8,  -1,   0,  -3,
    -14, -10,  -5,  -2,  10,  -8,  -5, -17,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][N_RANK] = {
  { 0, -6, -3, -6, 13, 45, 93, 0 },
  { 0, -7, -2, 14, 40, 76, 120, 0 }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 1, 2, 6, 17, 36, 47, 0 },
  { 0, 0, 1, 4, 12, 19, 24, 0 },
};

const int doubled_penalty[N_PHASES] = {5, 22};
const int backward_penalty[N_PHASES] = {2, 0};
const int isolated_penalty[N_PHASES] = {5, 5};

const int rook_file_bonus[N_PHASES][2] = { {8, 32}, {4, 5} };
const int bishop_pair[N_PHASES] = {40, 42};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { -8, 1, 14, 24, 38, 45, 53, 61, 72 },
    { -14, 5, 21, 21, 30, 38, 43, 41, 44, 48, 56, 72, 72, 92 },
    { -58, -9, 5, 9, 12, 14, 17, 23, 27, 34, 36, 37, 41, 37, 39 },
    { -102, -68, 10, 19, 18, 20, 22, 23, 24, 23, 21, 22, 22, 20,
       26, 21, 22, 25, 30, 39, 39, 36, 39, 34, 44, 35, 15, 25 },
  }, {
    {},
    { -52, -7, 9, 18, 20, 28, 25, 24, 14 },
    { -20, -16, -3, 9, 16, 19, 22, 24, 27, 24, 22, 22, 34, 21 },
    { -55, -2, 14, 30, 39, 45, 51, 52, 54, 57, 61, 64, 66, 70, 68 },
    { -80, -63, -11, 11, 25, 19, 21, 36, 51, 56, 64, 64, 69, 79,
       83, 86, 84, 88, 89, 95, 90, 97, 92, 99, 93, 87, 90, 77 },
  }
};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
