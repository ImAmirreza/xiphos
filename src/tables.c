/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018, 2019 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   -3,   8, -14,  11,  37,  35, -12, -39,
  -14,  -9,  17,  11,  67,  37,   6,  -8,
  -16,  -4, -16,  -5,  -6,  -7,  -1, -15,
  -23, -31, -11, -20, -12, -12, -25, -41,
  -32, -24, -31, -36, -23, -26, -10, -41,
  -32, -14, -25, -21, -22,  -5,  13, -29,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -137, -89, -49, -30,   7,-124,-120, -86,
   -4,  14,  42,  58,  28,  60,  24,  19,
    9,  31,  45,  48,  77,  89,  54,  22,
   43,  58,  55,  72,  61,  72,  55,  69,
   50,  44,  63,  63,  72,  74,  73,  61,
   32,  41,  40,  47,  55,  58,  60,  40,
   19,  21,  35,  42,  51,  42,  54,  40,
   -7,  40,  20,  40,  53,  34,  38,  15
  }, {
   40,   0, -69, -68, -63, -92, -22,  -2,
   -8,   7,   5, -12,  26,   7,  -3, -34,
   13,  14,  20,  41,  56,  53,  21,  31,
   16,  48,  29,  46,  44,  37,  52,  19,
   31,  27,  34,  53,  61,  42,  43,  51,
   30,  42,  36,  34,  36,  47,  52,  36,
   48,  39,  38,  26,  33,  46,  58,  46,
   34,  40,  29,  25,  30,  20,  22,  44
  }, {
    3,  -8, -17,  17,   1, -32,  -3,  14,
   -5, -19,   8,  30,  -3,  18, -31,   1,
   -9,   9,  -2,  12,  35,  27,  10, -15,
  -14,  -6,  12,   9,  21,  24,  -4,   0,
  -21, -22,  -7,   4,   8,  10,  19, -16,
  -17,   1,  -7,   5,   5,   4,  13, -12,
   -8,  -5,   0,   8,  11,   9,   7, -45,
    2,   5,   9,  24,  22,  18,  -8,   5
  }, {
  -41, -11,  30,  16,  11,  41,  23,   8,
  -21, -16,   2, -19, -58, -10, -22,   0,
   -1,  17,  20,  23,  15,  19,   4,  -3,
   -4,  19,  21,   4,  26,  17,  23,   6,
   27,  16,  19,  11,  34,  19,  39,  21,
    9,  28,  16,  22,  24,  24,  42,  15,
   11,  24,  32,  28,  27,  44,  42,  18,
   17,  15,  21,  27,  19,  13,   0,   7
  }, {
    2,  20,  69, -21, -37, -57,  74,  90,
   15,  81,  40,  44,  25,  54, -25, -45,
  -16,  51, 136,  55,  67, 153,  62, -35,
  -49,  27,  68,  30,  38,  64,  20,-157,
  -57,  43,  21,   3,   2,  -2,   4,-106,
  -68,  -8, -12,  -9, -19, -14,   5, -40,
   -3,  -2,  -2, -45, -34, -15,  12,  14,
    0,  17,   5, -44,   6, -30,  23,  10
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   15,  14,  22,  34,  43,  23,  32,  16,
   10,   7,   3,   6,  19,   2,  16,  11,
    5,  -5,  -9, -17, -13,  -5,   0,   0,
   -6,  -5, -20, -24, -20, -14,  -9, -13,
  -13,  -9, -17, -12, -14, -11, -17, -21,
  -12,  -9,  -9, -11,   0,  -7, -12, -24,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -48, -16, -20, -30, -37, -39, -28, -75,
  -16, -10, -29, -22, -12, -14,  -6, -48,
  -10, -11,  12,   9,   7,  -5,  -6, -33,
   -9,  -7,  14,  20,  15,  11,  -4, -19,
  -10,   1,  13,  16,  17,  14,  -3,  -7,
  -19,  -9,   5,  10,   8,  -3, -13, -13,
  -31,  -9, -15,   0,  -6, -20,  -7, -24,
  -35, -23, -17,  -6, -22, -15, -20, -40
  }, {
   -3, -13, -20, -13, -17,   1, -18, -21,
   -6,  -4,  -8, -13, -11, -14,  -7, -15,
   -9,  -6,   0,  -2,   0,   3,  -4, -12,
   -3,  -3,   1,  13,  13,   2,  -4, -17,
   -4,  -5,   8,  11,   9,   8, -11, -20,
  -11,  -3,   1,   6,   3,   4,  -8,  -7,
  -12, -14, -11,  -4,  -5, -10, -15, -28,
  -12, -15,  -6,  -9,  -9,  -2, -27, -26
  }, {
   24,  31,  30,  30,  32,  32,  33,  36,
   28,  33,  36,  32,  24,  26,  36,  27,
   27,  27,  30,  27,  20,  26,  16,  15,
   30,  32,  24,  30,  23,  17,  22,  19,
   38,  35,  29,  30,  23,  18,  15,  20,
   30,  31,  37,  20,  23,  13,  13,  17,
   22,  23,  29,  23,  18,  15,  10,  17,
   26,  22,  25,  14,  17,  15,  23,  13
  }, {
   22,  42,  31,  33,  13,  44,  16,  16,
   46,  44,  46,  56,  63,  61,  37,  30,
   31,  40,  31,  52,  47,  18,   9,  -6,
   55,  42,  57,  65,  48,  33,  48,  27,
   20,  45,  52,  57,  46,  54,  48,  38,
   24,  20,  44,  30,  45,  50,  31,  17,
   20,   7,  -1,  21,  22,  -9, -13,  -3,
    4,  -2,  -7, -14,  10,  -3,   5,  12
  }, {
  -47, -37, -16, -10,  -6, -31, -49, -37,
   -7,  10,   0,  -1,   6,   8,  19, -10,
   -2,   2,  15,  17,  14,  20,  11,  -3,
   -9,  10,  12,  18,  13,  23,  15,   3,
   -2,  11,  18,  21,  18,  16,  10,  -6,
   -5,   6,  14,  16,  18,  18,   6, -11,
  -21,  -4,  10,  12,  14,  14,   3, -17,
  -44, -28,  -5,  -1, -20,   1, -15, -43
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    4,  21,  16,   4,   8,  19,  12,   3,
   15,  27,   3,   2,   7,   2,   4,  10,
    1,   0,   1,   4,   1,  -7, -10,   5,
    6,  -4,  14,  -7, -13,  -2,  -6,  -5,
   34,  96,  63, -22, -40, -15,  19,  -2,
   30,  35,  83,  35,  65,  31,  -5, -39,
  -24, -27, -12,  -6,  -5,  -9, -13, -25
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
  -27, -68, -13, -40, -29,  -4, -22,  -2,
   20,   1,   0, -11,  -1,   8,  13,  25,
   25,  -2,   1,   3,   7,  -5,  -1,   9,
   16,  33,  -2,   6,  15,  -6,   5,   5,
   13,  22,  -4,   1,   2,   4,  -3,   6,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
   47,  20, -25,  13, -63, -51,  18,  71,
  -30,-126, -70,  -6, -62, -83, -74, -36,
  -16,  -3, -26, -19, -15, -19, -11, -11,
   23,   7, -15,  -8,  -6, -13,   6,  -5,
   16,  42,   7,   7,   8,   2,  22,  20,
   28,  34,  -2,   1,  -2,  11,   7,   9,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      1,   8, -24,  34,  12,  23, -14,  32,
     -1,  -4,   4,  11,  26,  41,  20,  15,
     -6,  18,   8,   7,  13,  12,  25,  13,
      5,  11,  15,  15,  16,   8,  27,  13,
     10,  -2,   3,  -2,   2,  -4,  10,   1,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     27,  18,  57,  28,  30,  37,  36,  19,
      8,  15,  -1,  -4,  10,  -3,   4,  -6,
      4,   2,   4,   9,   3,   3,  -2,   2,
     -1,   4,   9,   6,  13,   5,   1,  -1,
     -5,   1,   1,   4,   5,  -8,  -1, -20,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    153, 127, 150, 162, 184, 138,  62,  23,
     25,  37,  71,  52,  46,  40,  90,  35,
     47,  37,  40,  35,  52,  30,  28,  33,
     20,  33,  23,  31,  33,  21,  36,  24,
     18,  29,  21,  31,  31,  19,  35,  25,
     18,   5,   9,  21,  16,  -2,  11,   6,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     44,  80,  36,  95,  72,  84,  62,  52,
     79,  66,  66,  50,  50,  48,  22,  56,
     26,  34,  37,  34,  32,  26,  24,  15,
      6,   6,  16,  23,  19,   8,   7,   9,
     -3,   6,   8,   5,   8,  -1,   1,  -8,
    -16,  -7,  -9,  -1,  -4,  -8,  -2, -25,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   98,  90,  90,  86, 103,  76,  82, 116,
   53,  33,  20,  33,  -3,  24, -13,  13,
   23,  14,  16,  16,  11,   6,  28,   3,
   20,   6, -18,   0,  -9,   0, -21,   9,
   -1,  -4, -22,  -7, -20, -11, -36,  12,
   -7,  -8,  -9,   9,  15, -35, -22,   3,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
  106, 114, 115, 111, 110, 117, 116, 120,
   61,  66,  74,  70,  63,  81,  88,  79,
   36,  40,  35,  38,  36,  38,  44,  43,
   27,  22,  22,  20,  24,  20,  36,  28,
   10,   1,  10,   3,   4,   2,  12,   3,
    3,  11,   0,   2,   0,  -6,   1,   0,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 2, 3, 7, 18, 39, 49, 0 },
  { 0, 3, 3, 7, 11, 18, 21, 0 },
};

const int doubled_penalty[N_PHASES] = {8, 24};
const int backward_penalty[N_PHASES] = {-2, 2};
const int isolated_penalty[N_PHASES] = {4, 2};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { 3, 21, 32, 40, 48, 55, 61, 67, 72 },
    { 1, 16, 30, 32, 40, 46, 47, 47, 48, 48, 51, 64, 73, 98 },
    { -62, 4, 19, 22, 27, 25, 28, 31, 34, 34, 33, 34, 36, 45, 38 },
    { -157, -5, 8, 11, 12, 13, 17, 17, 21, 21, 22, 20, 20, 19,
        18, 20, 18, 8, 9, 16, 14, 19, 40, 0, 39, 34, 10, 25 },
  }, {
    {},
    { -66, -13, 8, 13, 19, 26, 24, 16, 0 },
    { -29, -9, -3, 9, 15, 23, 24, 26, 30, 26, 28, 12, 19, 2 },
    { -28, 6, 35, 43, 50, 56, 58, 59, 61, 66, 69, 68, 69, 68, 68 },
    { -11, -19, -25, 16, 17, 39, 42, 53, 51, 67, 79, 87, 87, 99,
      104, 104, 104, 110, 102, 95, 86, 77, 66, 74, 71, 70, 80, 86 },
  }
};

const int threats[N_PHASES][N_PIECES - 2][8] = {
  {
    {},
    { -3, -1, 23, 63, 31 },
    {  5, 22, -2, 44, 38 },
    {  1, 21, 22,  5, 41 },
  }, {
    {},
    { 13, 14, 42, 30,  5 },
    { 11, 41, 33, 29, 41 },
    { 14, 26, 43,  7, 24 },
  }
};

const int threat_king[N_PHASES] = {4, 31};
const int threat_protected_pawn[N_PHASES] = {56, 48};
const int threat_protected_pawn_push[N_PHASES] = {14, 13};
const int threats_on_queen[N_PIECES][N_PHASES] = {
  {}, {16, -6}, {18, 25}, {20, 4}, {}, {}
};

const int rook_file_bonus[N_PHASES][2] = { {14, 27}, {2, 6} };
const int bishop_pair[N_PHASES] = {40, 42};
const int pawn_mobility[N_PHASES] = {1, 7};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
