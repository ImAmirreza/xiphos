/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   -4,  10, -20,  17,  28,  61,   3, -50,
  -11, -21,  13,   4,  46,  43,  11, -15,
  -15,  -1, -15,  -4,  -8, -10,  -9, -19,
  -22, -33, -10, -19, -11, -15, -27, -42,
  -34, -26, -36, -35, -23, -29, -13, -40,
  -33, -14, -25, -25, -22,  -7,  12, -29,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -146, -88, -76, -50, -10,-118, -83, -98,
  -32, -21,  95,  35,  36,  77,  33,  -3,
    5,  67,  60,  59, 108, 109,  78,  34,
   44,  53,  56,  66,  56,  68,  48,  54,
   48,  43,  60,  63,  67,  69,  65,  58,
   29,  35,  31,  45,  53,  55,  56,  35,
   15,  15,  30,  35,  46,  34,  47,  38,
  -36,  39,   4,  33,  50,  30,  34,  23
  }, {
   16, -19, -96, -92, -75, -98, -10,  16,
   -9,  34,   3, -28,  26,  42,  35, -56,
   11,  26,  52,  45,  62,  58,  23,  25,
   17,  54,  33,  54,  46,  41,  56,   8,
   29,  22,  33,  53,  62,  43,  41,  51,
   28,  37,  31,  31,  33,  46,  48,  33,
   38,  36,  33,  19,  26,  41,  56,  43,
   21,  36,  26,  19,  27,  14,  10,  29
  }, {
    3,   9, -25,  17,  27, -26, -12, -12,
    2,  -5,  23,  38,  24,  32, -26,   4,
   -8,  12,   6,  12,  13,  15,  34, -21,
  -14,  -1,  13,  18,  22,  25, -13,  -8,
  -22, -17,  -9,   5,   7,   5,  13, -18,
  -22,  -4,  -9,   3,   0,  -2,   3, -18,
  -15, -12,  -6,   1,   6,   1,   3, -55,
   -2,   2,   5,  19,  15,  13, -16,  -2
  }, {
  -20, -18,  26,  16,  51,  48,  35,  40,
  -29, -52,  -9, -34, -63, -13, -27,  -5,
  -10,   2,   8,  -1,   1,  21,  15,  22,
  -21,   5,  -8, -15,   5,  10,   9,   3,
   19,  -5,   6,  -2,  21,  12,  25,  15,
    2,  20,   6,  14,  15,  17,  32,   3,
    7,  22,  30,  21,  23,  33,  26,  18,
   15,  13,  19,  29,  16,   6,  -3,  -1
  }, {
  -24,  44,  65, -14, -83, -59,  57,  70,
   29,  76,  32,  37,  19,  33, -18, -35,
  -21,  61, 146,  36,  66, 132,  70, -39,
  -54,  41,  61, -11,  29,  42,  33,-116,
  -63,  32,  21,   2,  -6,  12,  15, -96,
  -60,   9,  -9,  -6, -23,  -8,  11, -40,
    0,   9,   2, -45, -26,  -6,  15,  14,
   -7,  20,   6, -49,   8, -33,  21,   6
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   13,  21,  28,  28,  40,  22,  32,  26,
    4,   5,   5,   3,   8,   1,  21,  14,
    3,  -5, -11, -17, -14,  -9,   1,   2,
   -5,  -5, -19, -23, -18, -15,  -9, -12,
  -12, -11, -15, -12, -14, -11, -16, -18,
  -12,  -9,  -9,  -6,  -4,  -4,  -9, -22,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -48, -26, -22, -40, -31, -44, -46, -73,
  -17,  -1, -36, -15, -15, -19, -17, -50,
  -18, -20,   4,   5,   0, -12, -15, -40,
  -10,  -8,  12,  13,  11,   7,  -3, -18,
  -14,   0,  12,  16,  11,  11,  -3, -11,
  -21,  -7,   5,   8,   7,  -3, -14, -12,
  -35,  -7, -15,   2,  -4, -18,  -8, -26,
  -22, -27, -11,  -3, -23, -13, -19, -48
  }, {
   -3, -15, -19, -12, -18,  -3, -25, -25,
   -7,  -6,  -6, -11, -11, -22, -11, -13,
   -8,  -8,  -5,  -3,   1,   4,  -3, -10,
   -1,  -1,   1,   8,  13,   3,  -2, -13,
   -3,  -3,   6,  11,   8,   5, -12, -21,
  -11,  -1,   0,   2,   1,   2,  -6,  -9,
   -9, -15, -13,  -5,  -4, -11, -15, -28,
  -13, -17,  -6, -11, -11,  -3, -20, -17
  }, {
   28,  33,  36,  33,  33,  34,  38,  43,
   30,  33,  36,  33,  21,  32,  39,  30,
   27,  27,  27,  29,  25,  30,  17,  19,
   30,  29,  25,  27,  24,  18,  23,  23,
   33,  32,  32,  26,  22,  20,  17,  20,
   28,  29,  32,  19,  21,  15,  18,  18,
   23,  22,  29,  24,  18,  16,  11,  20,
   25,  21,  24,  14,  17,  15,  25,  14
  }, {
   11,  32,  26,  33,  17,  33,  17,  33,
   21,  29,  28,  40,  56,  48,  33,  21,
   13,  14,   0,  41,  43,  23,  10,   4,
   48,  26,  42,  40,  42,  29,  45,  26,
   14,  54,  36,  46,  31,  33,  48,  42,
   22,  16,  41,  27,  38,  38,  26,  37,
   16,   6,   0,  22,  21,  -7,  -6,   5,
   -3,  -5,  -4, -17,  11,  -4,   4,   2
  }, {
  -74, -32, -14, -13,  -5,  -7, -28, -32,
  -11,   8,  -2,  -2,   4,  15,  16,  -7,
    0,   8,  14,  16,  17,  24,  18,   9,
   -2,  10,  13,  20,  14,  25,  20,   3,
    3,   9,  19,  19,  19,  15,  12,   0,
   -1,   5,  13,  13,  17,  17,   6,  -8,
  -16,  -6,   8,  10,  11,  11,   2, -17,
  -35, -26,  -7,   1, -17,   0, -16, -41
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    3,  20,  18,  -1,  10,  16,  10,   0,
   13,  24,   6,   2,   5,   5,   6,   9,
    5,  -6,   1,   5,   0,  -4, -10,   3,
   17,  -3,  11,  -6,  -9,  -3,  -4,  -4,
   41, 104,  38, -18, -34, -17,   6,  -2,
   -5, -12,  37,  53,  43,   4, -47, -21,
  -23, -17,  -8,  -7,  -3,  -7, -10, -22
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
  -16, -83, -14, -54, -35,  -9, -21, -17,
   22,   2,   1, -11,  -3,   1,  13,  20,
   18,  -4,   2,   2,   4,  -5,  -1,   5,
    9,  30,  -1,   3,  13,  -6,   5,   4,
    7,  20,  -2,  -2,  -4,   2,  -3,   2,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
    9,  18,  27, -25, -74, -69,   4,  19,
  -27,-139, -18, -13, -39, -50, -32,   3,
  -16,  44, -25, -16, -24, -16,  -5,   7,
   -6,   5, -12, -10, -15, -12,  -4, -11,
   15,  29,   3,   4,   5,  -2,  19,  10,
    5,  10,   0,   2,  -8,  12,   5,   2,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     10,  31,  -2,  -2,  64,  10,  34,   8,
     -2,  -6,   1,  13,  27,  35,  20,  15,
     -7,  17,   8,   6,  11,  11,  23,  14,
      4,  12,  14,  13,  16,  11,  25,  13,
     10,  -2,   6,  -2,   1,  -3,  10,   3,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     30,  23,  50,   9,  47,  40,  19,  27,
     10,  15,   1,  -5,   7,   2,   4,  -9,
      4,   3,   5,   9,   4,   4,  -1,   2,
     -1,   4,   8,   7,  12,   5,   0,  -2,
     -5,   1,  -1,   3,   9,  -8,  -3, -19,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    137,  75, 114, 112, 161, 118,  42,  44,
     21,  31,  59,  28,  57,  39,  55,  41,
     51,  33,  40,  35,  53,  39,  39,  49,
     30,  36,  22,  29,  30,  21,  35,  26,
     18,  32,  20,  31,  31,  19,  38,  23,
     15,  10,  12,  21,  16,   1,  16,   4,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     35,  56,  53,  50, 116,  95,  40,  49,
     61,  67,  48,  59,  49,  57,  40,  51,
     24,  32,  34,  32,  30,  27,  22,  15,
      4,   6,  13,  21,  17,  10,   6,   9,
      0,   5,  10,   7,   7,  -1,  -1,  -7,
    -15, -10,  -7,  -1,   4,  -7,  -4, -21,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][N_RANK] = {
  { 0, -3, -4, -2, 17, 40, 90, 0 },
  { 0, -4, 4, 18, 39, 74, 116, 0 }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 2, 3, 7, 18, 38, 49, 0 },
  { 0, 2, 3, 5, 11, 18, 23, 0 },
};

const int doubled_penalty[N_PHASES] = {6, 22};
const int backward_penalty[N_PHASES] = {-1, 3};
const int isolated_penalty[N_PHASES] = {4, 2};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { -7, 13, 25, 35, 43, 51, 58, 65, 72 },
    { -5, 12, 26, 28, 37, 43, 45, 46, 47, 47, 53, 63, 72, 88 },
    { -63, -1, 15, 17, 21, 21, 24, 28, 31, 34, 34, 32, 35, 43, 33 },
    { -113, -54, 15, 19, 18, 18, 22, 20, 24, 23, 23, 22, 20, 17,
        17, 14, 18, 13, 16, 26, 29, 25, 34, 20, 42, 35, 19, 26 },
  }, {
    {},
    { -50, -7, 11, 15, 19, 27, 23, 17, 1 },
    { -21, -8, -2, 9, 15, 23, 22, 24, 27, 22, 25, 10, 21, 7 },
    { -43, 6, 28, 40, 48, 55, 56, 58, 59, 64, 64, 65, 67, 67, 67 },
    { -5, -49, -11, 10, 19, 29, 34, 48, 47, 60, 69, 75, 77, 86,
       89, 95, 94, 92, 87, 92, 83, 86, 78, 85, 79, 74, 87, 78 },
  }
};

const int threats[N_PHASES][N_PIECES - 2][8] = {
  {
    {},
    { -2, -6, 22, 51, 27 },
    {  3, 18, -3, 40, 35 },
    { -1, 17, 19,  0, 54 },
  }, {
    {},
    { 12, 11, 39, 31, 11 },
    {  9, 38, 15, 28, 51 },
    { 13, 26, 38,  7, 34 },
  }
};
const int threat_king[N_PHASES] = {20, 24};
const int threat_protected_pawn_push[N_PHASES] = {16, 11};

const int rook_file_bonus[N_PHASES][2] = { {13, 30}, {4, 7} };
const int bishop_pair[N_PHASES] = {42, 43};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
