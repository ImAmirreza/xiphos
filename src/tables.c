/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
  -13,   9, -25,  18,  19,  73,   1, -36,
   -7, -34,  12, -11,  38,  58,  24, -22,
  -19,   3, -15,  -3,  -8,  -6,  -8, -29,
  -26, -40, -10, -14,  -9, -17, -35, -43,
  -32, -27, -38, -28, -23, -30, -14, -38,
  -36, -18, -28, -32, -24,  -7,   1, -33,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -161, -85, -88, -42,  -5,-117, -75,-113,
  -45, -36, 106,  19,  45,  77,  32, -22,
  -10,  84,  49,  58,  94, 120,  92,  44,
   36,  56,  43,  71,  61,  68,  51,  41,
   43,  50,  56,  58,  69,  64,  58,  53,
   21,  22,  30,  41,  51,  46,  53,  26,
   17,  -3,  21,  24,  37,  39,  38,  34,
  -50,  39, -10,  17,  45,  15,  33,  32
  }, {
   -4,  -5,-110, -94, -72, -90,   2,  13,
  -19,  22, -12, -43,  15,  53,  30, -52,
   10,  34,  65,  34,  53,  58,  37,  36,
    6,  47,  25,  52,  41,  46,  40,  11,
   29,  22,  29,  43,  59,  34,  32,  44,
   17,  34,  26,  26,  31,  48,  37,  26,
   28,  38,  32,   7,  19,  31,  55,  27,
    6,  28,  26,  14,  23,  15,  -4,  13
  }, {
   -6,  20, -33,  26,  35, -24,  -9, -27,
   -4,  10,  20,  30,  41,  27, -15,   4,
  -17,   6,  15,   8,   1,   4,  47, -25,
  -27,   1,   8,  25,  19,  32, -19, -23,
  -35, -15,   0,   3,  14,  -1,  16, -29,
  -31,  -6,  -7,  -4,  -2,   6, -12, -30,
  -24,  -8, -12,  -1,   9,   5,  -4, -57,
   -5,  -1,   7,  17,  15,   8, -28,  -8
  }, {
   -6, -11,  35,  19,  61,  48,  36,  51,
  -36, -68, -10, -22, -56,  -1, -13,   5,
    2,   0,  20, -12,  13,  21,  26,  35,
  -31,   0, -19, -24,  -3,   8,   9,   7,
   16, -17,   7,  -6,  14,  15,  14,   6,
   -3,  21,   0,  13,  12,  11,  28,   7,
   -2,  15,  32,  12,  24,  31,  13,  27,
   18,   6,  17,  30,  10,   2,   8, -19
  }, {
  -37,  45,  54, -23, -85, -42,  48,  53,
   21,  73,  37,  34,  24,  23, -14, -24,
  -26,  54, 134,  26,  60, 121,  67, -45,
  -58,  45,  58, -25,  19,  26,  29,-105,
  -75,  19,  13, -13, -18,   7,   3, -98,
  -52,   4, -12,  -9, -36, -15,   3, -47,
   -3,  12,  -3, -45, -34,   0,  12,  15,
  -19,  21,   5, -53,   9, -33,  23,   9
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,  0,
    6,  19,  23,  23,  38,  18,  41,  36,
    7,   8,   6,   3,   2,   2,  15,  15,
    0,  -9, -10, -15, -13, -11,  -2,  -3,
   -7,  -9, -15, -18, -15, -16, -13, -14,
  -14, -13, -15, -13, -11, -12, -17, -19,
  -11, -12,  -7,  -8,  -4,  -6, -10, -19,
    0,   0,   0,   0,   0,   0,   0,  0
  }, {
  -51, -41, -12, -30, -17, -37, -54, -80,
  -28, -11, -24,  -2, -12, -24, -20, -46,
  -28, -15,   3,   4,  -3,  -6, -18, -38,
  -12,   0,  14,  13,  13,   6,  -3, -13,
   -7,  -8,  11,  15,  12,  11,   3, -10,
  -18,  -4,   0,   9,   6,  -2, -17,  -9,
  -25, -16, -10,   0,  -1, -12, -17, -29,
  -17, -23, -17,  -1, -16, -11, -22, -35
  }, {
  -16, -20, -24, -20, -16, -15, -15, -21,
  -10,  -8,  -7, -13,  -7,  -9,  -7, -19,
   -7,  -9,  -4,  -6,  -5,   4,  -4,  -7,
   -6,  -3,   2,   7,   8,   2,  -5,  -3,
   -8,  -3,   3,   9,   0,   4,  -6, -11,
  -10,  -5,   2,   2,   4,  -2,  -3,  -8,
  -10, -14, -11,  -4,  -1,  -9, -12, -22,
  -24,  -6,  -8,  -9, -10,  -8,  -6,  -9
  }, {
   33,  30,  38,  36,  36,  35,  32,  30,
   26,  27,  28,  26,  19,  27,  34,  25,
   23,  26,  21,  25,  20,  18,  20,  15,
   24,  21,  30,  19,  22,  22,  18,  22,
   26,  28,  30,  24,  21,  19,  18,  17,
   24,  22,  20,  22,  20,  15,  20,  12,
   22,  20,  24,  25,  19,  15,  14,  20,
   18,  22,  20,  15,  15,  16,  21,   7
  }, {
    5,  37,  24,  34,  31,  19,  22,  49,
    9,  13,  14,  41,  47,  35,  33,  22,
    5,   1, -12,  36,  37,  21,  15,  16,
   40,  20,  26,  25,  31,  24,  43,  39,
    9,  42,  28,  36,  20,  22,  45,  45,
   22,   7,  30,  22,  25,  26,  27,  50,
   14,   0,   0,  18,  17,   0,  -5,  12,
   -1,  -3,  -1, -17,  12,  -3,  11,  -7
  }, {
  -87, -41,  -5, -22,  -6,   5, -15, -18,
  -25,   3,   9,  10,   8,  20,   0,   0,
   -2,   5,   7,   3,   5,  29,  28,   1,
   -5,  11,  14,   9,   5,  14,  12,  -1,
   -5,  -1,  14,   9,   9,  12,   3,  -5,
   -1,   6,  12,   8,   9,  12,   9,  -2,
  -16,  -1,  10,   5,   6,   8,   2, -11,
  -43, -18,  -5,  -4, -14,   1, -12, -35
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    4,  16,  15,   3,   6,  15,  11,   1,
    6,  18,   1,   1,   6,   7,   8,   8,
    5, -11,   0,   7,  -1,  -1,  -5,   6,
   27,  -7,   7,   0,  -2,  -3,  -9,   3,
   36,  96,  24, -15, -22,  -7,  -1,  -2,
  -14, -29,  19,  51,  25,  -4, -58, -11,
  -19, -24, -12,  -8,  -6, -10, -13, -12
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
   -2, -86, -22, -57, -19, -21, -33, -28,
    9,   5,  -1,  -9,  -6,  -6,   7,  10,
    9,   1,  -1,   5,   3,  -6,  -1,   2,
    0,  28,   1,   6,   9,  -6,   5,   6,
    2,  13,   5,   7,  -1,   3,  -2,   2,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
   -9,  14,  35, -34, -78, -79,   3,   2,
  -17,-133,  -3, -15, -24, -40, -13,  17,
  -10,  52, -27, -14, -20, -12,  -7,  21,
  -19,   9, -10, -12, -19,  -7, -14,  -5,
   26,  22,   5,   4,   6,  -5,  16,   0,
  -12,  -2,   0,   0, -12,   9,   2,  -4,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     25,  44,  11, -13,  68,  19,  47,   0,
     -6,  -5,  -2,  15,  21,  22,   6,  23,
     -2,  11,   7,   7,  15,  17,  21,  12,
      1,   9,  12,  11,  14,  13,  18,  13,
      8,  -2,   7,  -3,   4,   5,   8,   6,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     24,  24,  44,  -2,  59,  36,  13,  37,
      7,   8,   3,   0,  12,  10,   1,   2,
      1,   1,   5,   5,   2,   6,   0,   0,
     -2,   1,   5,   4,   7,   2,   2,  -1,
     -1,   4,  -3,   5,   5,  -4,  -2, -15,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    119,  64,  96,  92, 156, 110,  41,  49,
     18,  20,  50,  14,  66,  38,  52,  39,
     40,  22,  37,  25,  42,  50,  52,  54,
     26,  40,  17,  21,  26,  14,  28,  33,
      8,  26,  19,  26,  27,  19,  33,  15,
     20,  14,  17,  15,  13,   5,  17,   0,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     34,  42,  69,  34, 132, 108,  29,  51,
     48,  58,  34,  50,  53,  64,  55,  44,
     30,  22,  24,  24,  27,  20,  23,  25,
     14,   9,   7,  17,  12,  10,  14,  13,
      0,   4,  10,  13,   7,   0,   0,  -2,
    -12,  -9,  -5,  -3,   8,  -7,  -5, -15,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][N_RANK] = {
  { 0, -6, -3, -6, 13, 45, 92, 0 },
  { 0, -8, -2, 13, 40, 77, 120, 0 }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 1, 2, 6, 17, 35, 47, 0 },
  { 0, -1, 1, 4, 12, 19, 24, 0 },
};

const int doubled_penalty[N_PHASES] = {6, 22};
const int backward_penalty[N_PHASES] = {3, 0};
const int isolated_penalty[N_PHASES] = {5, 5};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { -8, 2, 15, 24, 34, 42, 49, 57, 66 },
    { -11, 4, 18, 19, 28, 35, 40, 40, 44, 49, 56, 70, 69, 85 },
    { -42, -9, 3, 8, 13, 15, 19, 25, 24, 31, 35, 35, 38, 37, 38 },
    { -86, -84, 24, 14, 20, 22, 19, 23, 24, 23, 22, 22, 24, 22,
       25, 24, 27, 27, 32, 40, 42, 39, 40, 35, 44, 34, 35, 33 },
  }, {
    {},
    { -50, -12, 7, 16, 19, 26, 26, 26, 16 },
    { -16, -15, -2, 8, 16, 20, 22, 24, 27, 24, 23, 23, 33, 22 },
    { -43, -3, 9, 25, 35, 42, 48, 51, 53, 58, 61, 65, 69, 75, 72 },
    { -80, -79, -1, 9, 26, 22, 25, 36, 47, 53, 60, 62, 65, 77,
       79, 84, 82, 85, 86, 98, 94, 99, 97, 95, 98, 95, 81, 82 },
  }
};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
