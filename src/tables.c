/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018, 2019 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int piece_value[N_PIECES] = { 100, 310, 330, 500, 1000, 20000 };
const int piece_phase[N_PIECES] = { 0, 6, 6, 13, 28, 0 };

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    5,  11,  -6,  16,  33,  35, -13, -39,
  -14,  -5,  21,  15,  67,  41,   5, -12,
  -16,   0, -12,  -1,  -2,  -3,  -5, -19,
  -21, -27,  -7, -16,  -9,  -8, -21, -39,
  -31, -26, -30, -39, -27, -30, -12, -38,
  -30, -18, -29, -25, -26,  -3,  12, -25,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -141, -90, -49, -29,  11,-120,-116, -84,
    0,  18,  46,  62,  32,  64,  25,  23,
   13,  35,  49,  52,  78,  93,  53,  26,
   47,  62,  59,  74,  65,  76,  59,  73,
   54,  48,  67,  65,  76,  74,  77,  65,
   28,  45,  44,  51,  53,  54,  56,  36,
   15,  20,  31,  44,  47,  38,  50,  36,
   -6,  36,  16,  36,  49,  30,  34,  11
  }, {
   36,   1, -67, -64, -59, -88, -20,   1,
   -4,   3,   9,  -8,  26,   7,  -7, -30,
   15,  18,  24,  45,  56,  57,  25,  35,
   17,  48,  33,  50,  45,  41,  56,  23,
   31,  31,  38,  52,  64,  46,  46,  54,
   34,  46,  40,  38,  40,  43,  48,  40,
   44,  40,  42,  26,  34,  43,  54,  42,
   30,  40,  25,  21,  26,  16,  18,  40
  }, {
    7,  -4, -13,  15,   2, -28,  -1,  12,
   -1, -15,  12,  33,   1,  15, -31,   5,
   -5,  13,   2,  16,  39,  31,  14, -11,
  -10,  -2,  16,  13,  25,  28,   0,   4,
  -17, -18,  -3,   7,  12,  10,  22, -12,
  -17,  -3,  -7,   1,   6,   8,  11, -12,
  -12,  -9,  -4,   4,   8,   5,   3, -46,
    6,   9,  13,  20,  21,  22, -10,   1
  }, {
  -37,  -7,  26,  15,  13,  37,  27,  12,
  -17, -12,   6, -15, -56, -14, -26,   4,
    3,  21,  21,  23,  19,  23,   8,   1,
    0,  23,  22,   8,  30,  21,  27,  10,
   31,  20,  23,  15,  34,  23,  43,  25,
   13,  32,  18,  22,  22,  28,  42,  19,
   15,  26,  30,  24,  27,  40,  38,  14,
   21,  16,  17,  24,  15,   9,  -4,   8
  }, {
    3,  22,  69, -21, -33, -57,  73,  93,
   15,  78,  41,  48,  29,  54, -25, -49,
  -18,  53, 137,  59,  71, 154,  66, -33,
  -49,  31,  71,  34,  42,  66,  24,-157,
  -56,  39,  25,   5,   6,   2,   4,-105,
  -65,  -6, -12,  -7, -15, -13,   5, -44,
   -7,  -6,  -6, -41, -33, -14,  16,  10,
   -4,  13,   1, -48,   2, -34,  27,   8
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   11,  10,  22,  30,  39,  25,  30,  12,
    6,  11,   2,   9,  23,   6,  14,   7,
    3,  -5,  -5, -13,  -9,  -1,  -2,  -4,
   -6,  -1, -16, -21, -16, -10,  -6, -15,
  -10,  -9, -16, -14, -12,  -9, -13, -18,
   -9,  -8,  -7, -15,  -4,  -4,  -8, -20,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -49, -16, -16, -26, -33, -35, -24, -71,
  -16,  -6, -25, -18,  -8, -10,  -4, -44,
   -6,  -7,  16,  13,  11,  -1,  -2, -29,
   -5,  -3,  18,  21,  19,  15,   0, -15,
   -6,   5,  17,  16,  21,  18,   1,  -3,
  -19,  -5,   5,  14,  12,  -1, -13,  -9,
  -27,  -9, -15,  -4,  -5, -19, -11, -20,
  -31, -27, -19, -10, -22, -19, -24, -44
  }, {
   -6,  -9, -16,  -9, -13,   0, -14, -17,
   -7,   0,  -4,  -9,  -7, -10,  -7, -11,
   -9,  -2,   4,   1,   4,   7,   0, -11,
   -7,   1,   3,  16,  14,   5,  -3, -13,
   -3,  -1,  11,  12,  11,   8,  -7, -16,
  -11,   1,   0,   6,   5,   3,  -8,  -6,
   -9, -18, -10,  -6,  -8, -11, -18, -32,
  -14, -19, -10, -13, -13,  -6, -27, -25
  }, {
   28,  35,  34,  33,  36,  36,  37,  38,
   30,  36,  36,  31,  28,  24,  33,  31,
   31,  31,  33,  29,  24,  30,  19,  19,
   33,  34,  28,  30,  27,  21,  26,  23,
   34,  34,  33,  28,  26,  22,  19,  23,
   26,  27,  33,  22,  19,  14,  13,  17,
   18,  19,  25,  19,  14,  11,   6,  13,
   22,  18,  22,  14,  15,  11,  19,  14
  }, {
   26,  41,  32,  35,  17,  40,  20,  20,
   50,  46,  50,  60,  67,  61,  40,  34,
   35,  40,  35,  56,  51,  22,  13,  -2,
   55,  46,  57,  66,  52,  37,  48,  31,
   21,  48,  50,  61,  46,  58,  50,  42,
   28,  20,  45,  31,  41,  51,  33,  18,
   20,   7,   3,  21,  18, -13, -14,  -2,
    4,  -1,  -8, -14,   8,  -7,   1,   9
  }, {
  -45, -33, -12,  -6,  -2, -27, -45, -33,
   -9,  14,   4,   3,  10,  12,  23,  -8,
    2,   6,  19,  21,  18,  24,  15,   1,
   -5,  14,  16,  22,  17,  22,  19,   7,
   -3,  15,  22,  20,  19,  20,  10,  -2,
   -9,  10,  15,  12,  14,  15,   6,  -7,
  -25,  -4,   7,   8,  10,  10,   3, -16,
  -48, -24,  -5,  -5, -20,  -3, -11, -40
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,  17,  20,   1,   4,  22,  15,   6,
   11,  23,  -1,  -2,   3,   6,   8,  14,
    1,  -4,  -3,   0,   2,  -3,  -6,   9,
    6,  -8,  10,  -3,  -9,   2,  -8,  -1,
   38,  92,  59, -18, -40, -11,  23,  -2,
   34,  39,  87,  36,  66,  31,  -1, -35,
  -28, -31, -16,  -6,  -5, -13, -17, -29
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
  -31, -68, -12, -36, -33,  -8, -26,  -6,
   24,  -2,  -4, -15,  -5,   4,   9,  24,
   21,   2,  -1,  -1,   4,  -6,  -5,   5,
   13,  32,   2,   2,  11, -10,   5,   8,
    9,  26,   0,   5,   6,   5,   1,  10,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
   51,  21, -21,  14, -63, -47,  18,  71,
  -26,-125, -74, -10, -58, -87, -78, -32,
  -20,  -3, -30, -23, -16, -23, -12, -15,
   19,   8, -16, -10,  -7,  -9,   2,  -9,
   12,  40,   5,   7,   9,   0,  18,  19,
   24,  30,   2,   5,   0,   7,   5,  10,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      5,  12, -20,  38,  12,  27, -12,  34,
     -1,  -2,   7,  12,  29,  41,  16,  15,
     -2,  15,   8,  10,  14,  13,  29,  14,
      6,  11,  14,  19,  18,   9,  24,  13,
     10,   0,   5,  -6,   2,  -7,   9,   0,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     31,  22,  53,  29,  26,  38,  37,  15,
      6,  12,   0,   0,   8,   1,   6,  -4,
      3,   2,   4,  13,   7,   3,  -1,   2,
      2,   3,  12,   6,  13,   5,   1,  -1,
     -5,   3,  -2,   5,   5,  -6,   2, -16,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
    152, 126, 152, 165, 184, 142,  65,  27,
     29,  41,  75,  56,  50,  44,  90,  39,
     47,  41,  44,  39,  56,  34,  32,  37,
     24,  37,  20,  31,  32,  21,  36,  28,
     22,  30,  25,  31,  31,  21,  35,  25,
     19,   1,   7,  17,  16,  -2,   7,   4,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     48,  84,  40,  95,  76,  88,  63,  56,
     78,  65,  70,  54,  54,  52,  26,  60,
     30,  38,  39,  38,  36,  30,  28,  19,
     10,  10,  20,  26,  19,  12,  11,  13,
      1,   6,  10,   9,  12,   3,   2,  -4,
    -15,  -3,  -5,  -1,  -1,  -7,   1, -21,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

const int passer_bonus[N_PHASES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
  102,  94,  94,  90, 102,  76,  86, 120,
   57,  37,  20,  37,   1,  28,  -9,  14,
   27,  10,  12,  12,  10,   3,  24,   4,
   24,   6, -17,  -4, -13,  -4, -19,   9,
   -5,  -5, -20, -10, -20, -15, -35,   8,
   -7,  -7,  -8,   5,  11, -39, -25,  -1,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
  102, 110, 116, 107, 106, 115, 116, 116,
   62,  66,  75,  70,  63,  85,  88,  77,
   40,  44,  37,  38,  38,  42,  48,  47,
   30,  26,  24,  22,  21,  24,  34,  30,
    6,   5,   6,   2,   4,   0,  12,   3,
    3,  11,   0,  -1,  -4,  -3,   5,   0,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int distance_bonus[2][N_RANK] = {
  { 0, 2, 3, 7, 18, 38, 46, 0 },
  { 0, 3, 3, 7, 11, 18, 21, 0 },
};

const int doubled_penalty[N_PHASES] = {8, 26};
const int backward_penalty[N_PHASES] = {0, 3};
const int isolated_penalty[N_PHASES] = {3, 4};

const int mobility[N_PHASES][N_PIECES - 1][32] = {
  {
    {},
    { -1, 17, 28, 39, 49, 54, 61, 66, 75 },
    { -3, 12, 26, 28, 39, 47, 50, 49, 50, 51, 55, 66, 73, 100 },
    { -66, 0, 17, 22, 23, 24, 27, 31, 34, 36, 36, 38, 40, 49, 38 },
    { -161, -5, 4, 7, 8, 9, 13, 14, 19, 21, 22, 22, 24, 23, 21,
        21, 20, 12, 13, 19, 14, 22, 36, 1, 35, 30, 6, 21 },
  }, {
    {},
    { -67, -17, 6, 17, 21, 29, 27, 20, 4 },
    { -33, -13, -4, 9, 17, 23, 27, 28, 30, 28, 27, 16, 23, 6 },
    { -28, 3, 37, 40, 47, 52, 55, 59, 61, 66, 68, 70, 70, 68, 64 },
    { -12, -23, -29, 14, 18, 40, 42, 57, 55, 71, 83, 89, 91, 99,
      106, 108, 104, 111, 105, 95, 86, 76, 62, 70, 67, 66, 76, 82 },
  }
};

const int threats[N_PHASES][N_PIECES - 2][8] = {
  {
    {},
    {  1, -5, 21, 59, 27 },
    {  5, 22,  2, 40, 34 },
    {  5, 19, 18,  9, 37 },
  }, {
    {},
    { 17, 10, 38, 26,  1 },
    { 15, 37, 29, 25, 37 },
    { 17, 23, 39, 11, 20 },
  }
};

const int threat_king[N_PHASES] = {8, 27};
const int threat_protected_pawn[N_PHASES] = {52, 44};
const int threat_protected_pawn_push[N_PHASES] = {13, 14};
const int threats_on_queen[N_PIECES][N_PHASES] = {
  {}, {12, -8}, {18, 21}, {18, 5}, {}, {}
};

const int rook_file_bonus[N_PHASES][2] = { {12, 27}, {1, 4} };
const int bishop_pair[N_PHASES] = {41, 44};
const int pawn_mobility[N_PHASES] = {2, 8};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
