/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
    {
    0,   0,   0,   0,   0,   0,   0,   0,
  -28,  -6, -21,  17,  23,  64,   4, -26,
  -13, -31,   6, -15,  27,  56,  20, -16,
  -23,  -4, -22,   4,   1,  -6, -17, -31,
  -26, -36, -11,  -5,  -3, -17, -35, -39,
  -35, -26, -36, -27, -23, -31, -14, -37,
  -34, -21, -25, -38, -24, -10,  -4, -36,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -159, -91, -88, -37, -15,-112, -73,-125,
  -50, -34,  97,  18,  32,  75,  22, -38,
  -12,  74,  43,  54,  79, 103,  84,  32,
   31,  50,  38,  64,  57,  61,  47,  35,
   35,  51,  53,  55,  66,  60,  52,  46,
   16,  20,  27,  36,  45,  42,  48,  21,
   12,  -2,  17,  20,  32,  36,  27,  27,
  -39,  27,  -9,   9,  38,  11,  21,  17
  }, {
   -9,  -6,-102, -90, -76, -84,   0,   4,
  -31,  14, -17, -33,   6,  34,  28, -60,
    8,  25,  56,  30,  46,  52,  33,  31,
    1,  39,  21,  50,  38,  40,  34,   9,
   22,  18,  25,  38,  51,  26,  28,  40,
   14,  31,  21,  20,  25,  40,  32,  24,
   21,  35,  29,   3,  15,  26,  50,  23,
   -2,  21,  17,   9,  17,   9,  -7,   6
  }, {
  -10,  17, -27,  24,  26, -27,   0, -24,
   -5,   8,  24,  32,  34,  29,  -6,   2,
  -18,  13,   9,   7,   3,   9,  40, -22,
  -25,   1,   9,  22,  21,  29, -16, -18,
  -32, -12,  -4,   3,  10,  -5,  12, -22,
  -33,  -5,  -6,  -2,  -4,   0, -12, -28,
  -30,  -8,  -8,   0,   6,   0, -10, -59,
  -10,  -5,   6,  18,  15,   7, -25,  -5
  }, {
  -10,  -5,  30,  24,  46,  39,  17,  37,
  -35, -71, -14, -27, -56,  -2, -23,  -5,
    3,   1,  11, -17,   5,  22,  23,  36,
  -30,  -6, -24, -31,  -9,   4,   7,   2,
   14, -19,   5, -14,   5,   9,  12,   8,
   -5,  20,  -6,   8,   7,   7,  28,   6,
    0,  15,  31,  11,  21,  29,   5,  28,
   19,   5,  15,  29,  12,   2,  10,  -9
  }, {
  -30,  30,  27, -33, -66, -24,  29,  22,
    3,  33,  18,  19,  12,  11,  -4, -17,
  -34,  41,  96,  21,  41,  92,  50, -44,
  -59,  27,  43, -15,   3,  26,  20, -78,
  -78,   5,  11, -16, -19,   5,   0, -92,
  -53,  -1, -13, -17, -37, -17,  -3, -49,
    3,   9,  -7, -49, -38,  -3,  12,  15,
  -19,  22,   9, -49,   9, -33,  25,   8
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   -8,  11,  18,  30,  56,  34,  46,  34,
   12,  13,   9,   3,   6,   8,  19,  18,
    0,  -9, -10, -15, -12,  -8,  -2,  -2,
   -7,  -9, -15, -16, -13, -13, -10, -13,
  -16, -15, -15, -12, -10, -12, -17, -19,
  -11, -13,  -7,  -9,  -3,  -6, -12, -20,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -53, -37,  -9, -26, -14, -37, -52, -81,
  -27, -10, -20,   2,  -7, -21, -16, -42,
  -26, -11,  -2,   0,  -3,  -8, -15, -33,
   -9,   3,  14,  14,  12,   6,   0,  -9,
   -5,  -6,   9,  15,  13,  11,   7,  -9,
  -15,  -2,  -1,   9,   6,  -2, -13,  -7,
  -25, -17,  -6,   1,   0, -10, -15, -30,
  -25, -26, -18,   0, -12,  -9, -24, -41
  }, {
  -13, -16, -21, -19, -12, -12, -13, -18,
   -7,  -6,  -6, -13,  -5,  -7,  -7, -18,
   -4,  -7,  -5,  -8,  -5,   2,  -3,  -3,
   -4,  -1,   2,   3,   2,   3,  -4,  -1,
   -6,  -2,   3,   6,  -1,   2,  -5,  -8,
   -9,  -4,   2,   3,   4,   0,  -2,  -8,
  -10, -14,  -9,  -3,   0,  -8, -10, -25,
  -24,  -6,  -8,  -7,  -8,  -9,  -7, -12
  }, {
   28,  26,  33,  31,  33,  34,  31,  26,
   25,  26,  25,  22,  18,  26,  32,  24,
   24,  26,  21,  25,  20,  18,  22,  15,
   25,  22,  30,  20,  21,  24,  20,  25,
   27,  29,  31,  23,  23,  22,  21,  19,
   24,  23,  20,  21,  19,  18,  23,  13,
   22,  20,  23,  24,  19,  16,  17,  19,
   18,  22,  19,  15,  14,  16,  20,   7
  }, {
    2,  31,  23,  25,  36,  23,  28,  46,
    6,  11,   8,  38,  41,  32,  36,  22,
    2,  -3, -12,  30,  35,  16,  16,  21,
   35,  19,  18,  18,  27,  22,  40,  41,
   10,  35,  23,  30,  22,  21,  44,  39,
   24,   7,  27,  18,  20,  26,  23,  43,
   10,  -2,  -2,  16,  17,  -7,  -4,  13,
   -3,  -4,  -4, -16,   7,  -6,   9, -17
  }, {
  -81, -40,  -1, -21,  -3,   5, -12, -15,
  -19,   7,  11,  15,  10,  24,   4,   3,
    3,   9,  11,   5,   7,  32,  32,   4,
   -2,  14,  17,  10,   7,  15,  14,  -1,
   -5,   1,  16,   9,   9,  12,   4,  -6,
   -1,   7,  12,   8,   9,  11,   9,  -1,
  -17,  -1,  11,   4,   6,   8,   2, -11,
  -45, -17,  -6,  -6, -14,   0, -12, -35
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    4,  15,  15,   6,   2,  15,  11,   1,
    8,  16,   2,   3,   7,   7,   8,   8,
    7, -10,   1,   4,  -1,  -1,  -4,   6,
   23,  -1,   8,  -1,  -1,  -2,  -9,   3,
   35,  53,  14, -13, -17,  -1,   7,  -4,
  -15, -12,   8,  28,  17,  13, -31,  -4,
  -19, -24, -12,  -8,  -6, -10, -13, -11
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
   -6, -26, -16, -26,  -8, -17, -17, -14,
    5,   5,  -2, -12,  -4,  -6,   4,   8,
    8,   1,  -4,   6,   3,  -6,  -2,   3,
    1,  21,  -2,   0,   5,  -6,   2,   5,
   -1,   7,   4,   5,  -1,   3,   0,   1,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
  -17,   5,   9, -14, -22, -25,  -1,  -3,
   -6, -26,   1,   3, -16, -19,  -5,  18,
   -3,  21, -16,  -5, -12,  -9, -12,  13,
  -16,   6,  -8,  -6, -17,  -4, -13,  -3,
   14,  17,   3,   2,   3,  -5,  15,   2,
   -8,  -1,  -1,  -2, -12,   9,   4,  -1,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     23,  33,  20,  -3,  35,  23,  34,  15,
      3,   5,   7,  14,  17,  21,  13,  22,
      1,  10,  10,   6,  13,  14,  18,   9,
      5,   9,  11,   8,  13,  12,  15,  12,
      4,   1,   7,  -1,   7,   5,   8,   7,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     22,  24,  37,   1,  37,  30,  10,  32,
      3,   8,   4,   1,  10,   6,   0,  -2,
      0,   1,   5,   3,   1,   4,  -3,  -2,
      0,   1,   5,   5,   7,   2,   2,  -1,
     -1,   3,  -3,   4,   1,  -3,  -2, -12,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
     90,  73,  87,  92, 117, 109,  72,  76,
     35,  37,  41,  28,  48,  46,  45,  41,
     44,  31,  39,  25,  37,  44,  45,  45,
     24,  34,  19,  18,  22,  16,  26,  29,
     14,  23,  19,  24,  26,  19,  31,  16,
     16,  13,  16,  13,  12,   8,  16,   3,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     55,  56,  79,  56, 105, 104,  48,  70,
     52,  50,  37,  51,  52,  59,  53,  46,
     26,  19,  23,  21,  22,  18,  24,  24,
     13,   7,   6,  12,   9,   7,  10,  11,
      2,   3,   9,  10,   6,  -1,   0,   1,
    -11,  -9,  -5,  -2,   3,  -7,  -5, -14,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
