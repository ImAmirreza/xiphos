/*
  Xiphos, a UCI chess engine
  Copyright (C) 2018 Milos Tatarevic

  Xiphos is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  Xiphos is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "eval.h"
#include "game.h"

int pst_mid[P_LIMIT][BOARD_SIZE], pst_end[P_LIMIT][BOARD_SIZE];
int distance[BOARD_SIZE][BOARD_SIZE];

const int pst_mid_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
  -27,  -4, -25,  18,  24,  78,   4, -28,
  -11, -33,   7, -16,  32,  57,  23, -19,
  -21,   0, -20,  -1,  -4,  -5, -11, -30,
  -25, -39,  -9, -10,  -6, -18, -34, -42,
  -34, -26, -38, -28, -24, -30, -14, -38,
  -36, -21, -25, -37, -26,  -8,  -2, -34,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
 -162, -96, -89, -41,  -9,-114, -72,-125,
  -48, -34, 100,  21,  37,  74,  27, -31,
  -12,  79,  44,  54,  85, 110,  86,  38,
   35,  52,  42,  68,  59,  63,  49,  37,
   38,  53,  54,  58,  69,  61,  52,  47,
   18,  21,  28,  38,  49,  45,  50,  22,
   13,  -5,  21,  23,  35,  38,  33,  30,
  -46,  28, -12,  13,  42,  14,  22,  24
  }, {
   -6,  -1,-108, -93, -75, -86,   4,  10,
  -22,  19, -16, -35,  10,  40,  28, -55,
    9,  29,  60,  32,  50,  55,  32,  34,
    2,  43,  21,  53,  38,  43,  37,  11,
   26,  18,  26,  38,  53,  29,  30,  41,
   15,  34,  23,  24,  29,  43,  33,  24,
   23,  37,  31,   6,  18,  30,  54,  22,
    1,  24,  21,  11,  18,  11,  -6,  10
  }, {
   -8,  20, -30,  24,  31, -27,  -5, -27,
   -4,   9,  22,  31,  35,  28, -11,   5,
  -18,   9,  13,   6,   5,   9,  43, -26,
  -27,   3,   8,  21,  19,  32, -21, -20,
  -33, -14,  -3,   4,  12,  -3,  11, -22,
  -31,  -7,  -6,  -2,  -2,   3, -11, -28,
  -28, -10,  -8,   0,   8,   3,  -7, -60,
   -7,  -2,   7,  17,  15,   8, -27,  -8
  }, {
   -9,  -9,  35,  22,  51,  42,  29,  45,
  -35, -69, -14, -25, -58,  -3, -20,   1,
    3,  -1,  16, -17,   6,  23,  20,  35,
  -31,  -5, -22, -32,  -8,   5,  10,   5,
   15, -20,   4, -11,   9,   9,  11,   8,
   -2,  21,  -4,   9,   7,   8,  27,   7,
   -1,  14,  32,  11,  23,  31,   9,  29,
   19,   8,  16,  30,  11,   3,   9, -11
  }, {
  -32,  35,  39, -27, -72, -27,  35,  35,
    8,  51,  25,  28,  15,  15, -10, -20,
  -32,  47, 109,  20,  44, 107,  56, -45,
  -60,  34,  51, -19,   7,  27,  25, -94,
  -79,   9,  10, -13, -18,   6,   1, -93,
  -52,   1, -10, -11, -37, -15,   1, -47,
    2,  10,  -3, -48, -36,  -1,  12,  15,
  -19,  21,   6, -50,   9, -34,  23,   9
  }
};

const int pst_end_base[N_PIECES][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
   -9,  12,  21,  31,  55,  29,  48,  35,
   10,  11,   8,   2,   2,   3,  17,  16,
    0,  -9, -10, -15, -13, -10,  -2,  -2,
   -7,  -9, -15, -17, -14, -15, -13, -14,
  -15, -13, -15, -12, -11, -12, -17, -19,
  -11, -12,  -7,  -9,  -4,  -6, -11, -19,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
  -53, -37,  -8, -26, -13, -36, -51, -81,
  -26,  -9, -21,   3,  -8, -19, -16, -42,
  -26, -12,  -1,   1,  -5,  -7, -14, -34,
  -10,   4,  14,  13,  11,   6,   0, -11,
   -4,  -6,   9,  15,  12,  11,   7,  -7,
  -15,  -3,   1,   9,   5,  -2, -13,  -5,
  -22, -15,  -6,   0,   1, -10, -15, -29,
  -24, -27, -15,  -1, -12,  -8, -23, -43
  }, {
  -15, -16, -21, -17, -10, -12, -12, -16,
   -8,  -7,  -6, -11,  -5,  -5,  -7, -18,
   -5,  -7,  -6,  -9,  -5,   2,  -2,  -4,
   -3,  -1,   2,   3,   3,   2,  -4,  -1,
   -6,  -1,   2,   7,  -1,   2,  -5,  -8,
   -8,  -4,   2,   3,   4,  -1,  -2,  -7,
   -9, -14,  -8,  -3,   0,  -8, -11, -23,
  -25,  -5,  -8,  -7,  -7,  -8,  -6, -11
  }, {
   29,  27,  33,  31,  34,  35,  32,  28,
   25,  26,  26,  23,  18,  27,  34,  25,
   24,  26,  21,  25,  20,  18,  23,  17,
   25,  22,  30,  20,  23,  25,  20,  25,
   28,  30,  30,  23,  24,  22,  22,  19,
   24,  24,  20,  22,  20,  18,  24,  14,
   22,  20,  24,  25,  20,  17,  15,  20,
   18,  22,  20,  15,  15,  16,  20,   7
  }, {
    4,  34,  23,  28,  35,  22,  26,  51,
    9,  11,   9,  38,  44,  33,  36,  22,
    3,   0, -13,  32,  35,  21,  17,  19,
   37,  20,  21,  20,  29,  24,  41,  41,
    9,  38,  25,  31,  19,  22,  45,  42,
   23,   7,  27,  19,  22,  26,  26,  46,
   12,  -2,  -1,  16,  17,  -5,  -5,  11,
   -1,  -3,  -3, -17,   8,  -4,  13, -16
  }, {
  -85, -41,  -1, -20,  -4,   6, -11, -14,
  -20,   7,  11,  14,  11,  24,   4,   3,
    2,   9,  11,   6,   7,  31,  32,   4,
   -3,  14,  16,  10,   7,  15,  14,  -1,
   -5,   1,  16,  10,   9,  12,   4,  -6,
   -1,   7,  12,   8,   9,  12,   9,  -2,
  -17,  -1,  10,   4,   6,   8,   2, -11,
  -42, -18,  -6,  -6, -14,   1, -12, -35
  }
};

const int pawn_shield[BOARD_SIZE] = {
    0,   0,   0,   0,   0,   0,   0,   0,
    4,  16,  15,   4,   3,  15,  11,   1,
    9,  17,   1,   2,   7,   7,   8,   8,
    6, -12,   1,   6,  -1,  -1,  -5,   6,
   26,  -4,   8,   1,  -2,  -3,  -8,   3,
   37,  74,  18, -14, -23,  -3,   6,  -3,
  -18, -15,  10,  36,  21,   4, -43,  -7,
  -19, -24, -12,  -8,  -6, -10, -13, -12
};

const int pawn_storm[2][BOARD_SIZE] = {
  {
    0,   0,   0,   0,   0,   0,   0,   0,
    0,   0,   0,   0,   0,   0,   0,   0,
   -8, -70, -19, -50, -13, -21, -24, -26,
    8,   5,  -3, -10,  -7,  -6,   6,   9,
    9,   1,  -2,   6,   3,  -6,  -1,   2,
    1,  26,  -1,   4,   8,  -6,   5,   6,
    0,  10,   5,   7,  -1,   3,  -2,   2,
    0,   0,   0,   0,   0,   0,   0,   0
  }, {
    0,   0,   0,   0,   0,   0,   0,   0,
  -21,   4,  16, -35, -57, -69,  -6,  -8,
  -11, -90,   3,   0, -18, -26,  -5,  24,
   -6,  34, -23,  -9, -15, -11, -10,  18,
  -20,   6,  -8, -11, -17,  -5, -13,  -2,
   25,  19,   4,   3,   6,  -5,  16,   0,
  -11,  -3,  -1,  -1, -12,   9,   2,  -4,
    0,   0,   0,   0,   0,   0,   0,   0
  }
};

const int connected_pawns[2][N_PHASES][BOARD_SIZE] = {
  {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     25,  42,  17,  -8,  54,  19,  37,   1,
     -3,   0,   3,  15,  18,  22,  10,  22,
     -2,  11,   8,   6,  14,  16,  20,  12,
      2,   9,  12,  10,  14,  12,  17,  13,
      4,   0,   7,  -2,   6,   5,   8,   6,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
     23,  23,  43,   0,  52,  34,  13,  36,
      6,   9,   3,   1,  12,   8,   1,   1,
      0,   1,   4,   4,   1,   6,  -1,  -1,
     -1,   1,   5,   5,   7,   2,   2,  -1,
     -1,   4,  -4,   2,   2,  -4,  -2, -14,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }, {
    {
      0,   0,   0,   0,   0,   0,   0,   0,
     97,  71,  82,  92, 147, 111,  58,  66,
     25,  23,  42,  17,  56,  43,  48,  38,
     39,  25,  38,  22,  40,  46,  46,  51,
     23,  38,  17,  18,  24,  16,  27,  31,
     13,  23,  18,  26,  26,  18,  33,  15,
     16,  15,  16,  13,  13,   6,  17,   2,
      0,   0,   0,   0,   0,   0,   0,   0
    }, {
      0,   0,   0,   0,   0,   0,   0,   0,
     53,  55,  82,  47, 137, 117,  43,  66,
     49,  55,  32,  50,  53,  63,  54,  45,
     30,  20,  23,  22,  25,  21,  25,  26,
     11,   9,   7,  14,  11,   9,  14,  13,
      1,   3,  10,  11,   6,  -1,   0,  -2,
    -11,  -9,  -6,  -2,   6,  -7,  -5, -15,
      0,   0,   0,   0,   0,   0,   0,   0
    }
  }
};

void init_distance()
{
  int i, j;

  for (i = 0; i < BOARD_SIZE; i ++)
    for (j = 0; j < BOARD_SIZE; j ++)
      distance[i][j] = _min(_max(_abs(_rank(i) - _rank(j)), _abs(_file(i) - _file(j))), 5);
}

void init_pst()
{
  int piece, sq, v;

  memset(pst_mid, 0, sizeof(pst_mid));
  memset(pst_end, 0, sizeof(pst_end));

  for (piece = 0; piece < N_PIECES; piece ++)
    for (sq = 0; sq < BOARD_SIZE; sq ++)
    {
      v = piece_value[piece] + pst_mid_base[piece][sq];
      pst_mid[piece][sq] = v;
      pst_mid[piece | CHANGE_SIDE][sq ^ 56] = v;

      v = piece_value[piece] + pst_end_base[piece][sq];
      pst_end[piece][sq] = v;
      pst_end[piece | CHANGE_SIDE][sq ^ 56] = v;
    }
}
